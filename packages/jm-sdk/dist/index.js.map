{"version":3,"file":"index.js","sources":["../lib/config.js","../lib/sso.js","../lib/passport.js","../lib/login.js","../lib/index.js"],"sourcesContent":["const error = require('jm-err')\r\nconst {Err} = error\r\nconst name = 'config'\r\n\r\nmodule.exports = function (opts) {\r\n  let app = this\r\n  this.bind(name)\r\n  const $ = app[name]\r\n\r\n  /**\r\n   * 获取配置\r\n   * @param root 根(必填)\r\n   * @param key 配置项(必填)\r\n   * @returns {Promise<*>}\r\n   */\r\n  $.getConfig = async function (root, key) {\r\n    if (!root || !key) throw error.err(Err.FA_PARAMS)\r\n    return this.get(`/${root}/${key}`)\r\n  }\r\n\r\n  /**\r\n   * 设置配置信息\r\n   * @param root 根(必填)\r\n   * @param key 配置项(必填)\r\n   * @param value 配置值(可选)\r\n   * @param expire 过期时间(可选, 单位秒, 默认0代表永不过期)\r\n   * @returns {Promise<void>}\r\n   */\r\n  $.setConfig = async function (root, key, value, expire = 0) {\r\n    if (!root || !key) throw error.err(Err.FA_PARAMS)\r\n    return this.post(`/${root}/${key}`, {value, expire})\r\n  }\r\n\r\n  /**\r\n   * 删除配置信息\r\n   * @param root 根(必填)\r\n   * @param key 配置项(必填)\r\n   * @returns {Promise<*>}\r\n   */\r\n  $.removeConfig = async function (root, key) {\r\n    if (!root || !key) throw error.err(Err.FA_PARAMS)\r\n    return this.delete(`/${root}/${key}`)\r\n  }\r\n\r\n  /**\r\n   * 删除根配置, 所有根下面的配置信息都被删除\r\n   * @param root 根(必填)\r\n   * @returns {Promise<*>}\r\n   */\r\n  $.removeRoot = async function (root) {\r\n    if (!root) throw error.err(Err.FA_PARAMS)\r\n    return this.delete(`/${root}`)\r\n  }\r\n\r\n  /**\r\n   * 列出配置项, 返回{rows:[]}\r\n   * @param root 根(必填)\r\n   * @returns {Promise<*>}\r\n   */\r\n  $.getKeys = async function (root) {\r\n    if (!root) throw error.err(Err.FA_PARAMS)\r\n    return this.get(`/${root}`)\r\n  }\r\n\r\n  /**\r\n   * 列出配置项及值\r\n   * @param root 根(必填)\r\n   * @returns {Promise<*>}\r\n   */\r\n  $.getConfigs = async function (root) {\r\n    if (!root) throw error.err(Err.FA_PARAMS)\r\n    return this.get(`/${root}?all=1`)\r\n  }\r\n\r\n  /**\r\n   * 设置多个配置信息\r\n   * @param root 根(必填)\r\n   * @param opts\r\n   * @returns {Promise<*>}\r\n   */\r\n  $.setConfigs = async function (root, opts = {}) {\r\n    if (!root) throw error.err(Err.FA_PARAMS)\r\n    return this.post(`/${root}`, {value: opts})\r\n  }\r\n\r\n  return {\r\n    name,\r\n    unuse: () => {\r\n      delete app[name]\r\n    }\r\n  }\r\n}\r\n","const name = 'sso'\r\n\r\nmodule.exports = function (opts) {\r\n  let app = this\r\n  this.bind(name)\r\n  let $ = app[name]\r\n\r\n  $.verify = async function () {\r\n    const uri = '/verify'\r\n    return this.get(uri)\r\n  }\r\n\r\n  $.touch = async function (opts) {\r\n    const uri = '/touch'\r\n    return this.post(uri)\r\n  }\r\n\r\n  $.signout = async function () {\r\n    const uri = '/signout'\r\n    return this.get(uri)\r\n  }\r\n\r\n  return {\r\n    name,\r\n    unuse: () => {\r\n      delete app[name]\r\n    }\r\n  }\r\n}\r\n","const name = 'passport'\r\n\r\nmodule.exports = function (opts) {\r\n  let app = this\r\n  this.bind(name)\r\n  let $ = app[name]\r\n\r\n  $.login = async function (username, password) {\r\n    let uri = '/login'\r\n    return this.post(uri, {username, password})\r\n  }\r\n\r\n  return {\r\n    name,\r\n    unuse: () => {\r\n      delete app[name]\r\n    }\r\n  }\r\n}\r\n","const name = 'login'\r\n\r\nmodule.exports = function (opts) {\r\n  let app = this\r\n  let doLogin = null\r\n\r\n  async function checkOrLogin () {\r\n    let store = app.store\r\n    let storage = app.storage\r\n    let doc = storage.getJson('sso')\r\n    if (doc) {\r\n      store.sso = doc\r\n      try {\r\n        doc = await app.sso.verify()\r\n      } catch (e) {\r\n        doc = e.data || {}\r\n      }\r\n      if (!doc || !doc.token) {\r\n        delete store.sso.token // 删除token\r\n        doc = null\r\n      }\r\n    }\r\n    if (!doc) {\r\n      if (app.login) {\r\n        doc = await app.login()\r\n        if (doc && doc.token) {\r\n          storage.setJson('sso', doc)\r\n          store.sso = doc\r\n        }\r\n      }\r\n    } else {\r\n      storage.setJson('sso', doc)\r\n      store.sso = doc\r\n    }\r\n    return doc\r\n  }\r\n\r\n  app.checkLogin = async function () {\r\n    if (doLogin) return doLogin\r\n    doLogin = new Promise(\r\n      async (resolve, reject) => {\r\n        try {\r\n          let doc = await checkOrLogin()\r\n          resolve(doc)\r\n        } catch (e) {\r\n          reject(e)\r\n        }\r\n        doLogin = false\r\n      }\r\n    )\r\n    return doLogin\r\n  }\r\n\r\n  /**\r\n   * 判断是否已经登陆\r\n   */\r\n  app.isLoggedIn = function () {\r\n    return this.store.sso\r\n  }\r\n\r\n  /**\r\n   * 登出\r\n   */\r\n  app.logout = function () {\r\n    delete this.store.sso\r\n    this.storage.removeItem('sso')\r\n  }\r\n\r\n  return {\r\n    name,\r\n    unuse: () => {\r\n      delete app.checkLgoin\r\n      delete app.isLoggedIn\r\n      delete app.logout\r\n    }\r\n  }\r\n}\r\n","const event = require('jm-event')\nconst utils = require('jm-ms-core').utils\nconst Core = require('jm-sdk-core')\nconst config = require('./config')\nconst sso = require('./sso')\nconst passport = require('./passport')\nconst login = require('./login')\n\nconst types = ['get', 'post', 'put', 'delete', 'patch']\n\nclass Sdk extends Core {\n  constructor (opts = {}) {\n    super(opts)\n    this.ready = false\n    this.store.config = opts\n\n    types.forEach(type => {\n      this.bindType(this, type)\n    })\n\n    const mdls = {\n      config,\n      sso,\n      passport,\n      login\n    }\n    let modules = Object.assign({}, opts.modules)\n    Object.keys(mdls).forEach(\n      key => {\n        if (!modules[key]) return\n        let cfg = Object.assign({}, opts, modules[key])\n        this.use(mdls[key], cfg)\n      }\n    )\n\n    this.onReady()\n  }\n\n  get router () { return this._router }\n\n  set router (value) {\n    if (!value) throw new Error('invalid router')\n    this._router = value\n    this.ready = true\n    this.emit('ready')\n  }\n\n  async onReady () {\n    if (this.ready) return this.ready\n    if (this.initing) return this.initing\n\n    this.initing = new Promise(\n      async (resolve, reject) => {\n        this.once('ready', doc => {\n          this.ready = true\n          resolve(this.ready)\n        })\n        delete this.initing\n      }\n    )\n    return this.initing\n  }\n\n  async request (...args) {\n    this.ready || await this.onReady()\n    if (!this.router) throw new Error('invalid router')\n    let opts = utils.preRequest(...args)\n    let sso = this.store.sso || {}\n    if (sso.token) {\n      opts.headers || (opts.headers = {})\n      opts.headers.Authorization = sso.token\n    }\n    const {logger} = this\n    const strRequest = `request:\\n${JSON.stringify(opts, null, 2)}`\n    try {\n      let doc = await this.router.request(opts)\n      logger.debug(`${strRequest}\\nresult:\\n${JSON.stringify(doc, null, 2)}`)\n      return doc\n    } catch (e) {\n      if (e.data && e.data.err === 401 && this.checkLogin) {\n        logger.debug('not login, so checkLogin and try again')\n        await this.logout() // clear old sso\n        sso = await this.checkLogin()\n        if (sso.token) {\n          opts.headers || (opts.headers = {})\n          opts.headers.Authorization = sso.token\n          try {\n            let doc = await this.router.request(opts)\n            logger.debug(`${strRequest}\\nresult:\\n${JSON.stringify(doc, null, 2)}`)\n            return doc\n          } catch (e) {\n            try {\n              const ret = await this.emit('error', e, opts)\n              if (ret !== undefined) {\n                logger.debug(`${strRequest}\\nresult:\\n${JSON.stringify(ret, null, 2)}`)\n                return ret\n              }\n              throw e\n            } catch (ee) {\n              logger.error(`${strRequest}\\nresult:\\n${JSON.stringify(ee.data || null, null, 2)}`)\n              throw ee\n            }\n          }\n        }\n      }\n\n      try {\n        const ret = await this.emit('error', e, opts)\n        if (ret !== undefined) {\n          logger.debug(`${strRequest}\\nresult:\\n${JSON.stringify(ret, null, 2)}`)\n          return ret\n        }\n        throw e\n      } catch (ee) {\n        logger.error(`${strRequest}\\nresult:\\n${JSON.stringify(ee.data || null, null, 2)}`)\n        throw ee\n      }\n    }\n  }\n\n  bindType ($, type, uri = '') {\n    $[type] = async (...args) => {\n      let opts = utils.preRequest(...args)\n      opts.uri = `${uri}${opts.uri}`\n      opts.type = type\n      return this.request(opts)\n    }\n  }\n\n  bind (name, uri) {\n    uri || (uri = '/' + name)\n    let $ = {}\n    event.enableEvent($, {async: true})\n    types.forEach(type => {\n      this.bindType($, type, uri)\n    })\n    this[name] = $\n    return this\n  }\n}\n\nmodule.exports = Sdk\n"],"names":["Err","error","name","opts","app","bind","$","getConfig","root","key","err","FA_PARAMS","get","setConfig","value","expire","post","removeConfig","removeRoot","getKeys","getConfigs","setConfigs","unuse","verify","uri","touch","signout","login","username","password","arguments","i","checkOrLogin","store","storage","doc","getJson","sso","e","data","token","setJson","doLogin","checkLogin","Promise","resolve","reject","isLoggedIn","logout","removeItem","checkLgoin","direct","utils","require$$0","require$$1","types","Sdk","ready","config","forEach","type","bindType","mdls","passport","modules","Object","assign","keys","cfg","use","onReady","initing","once","args","router","Error","preRequest","headers","Authorization","logger","strRequest","JSON","stringify","request","debug","emit","ret","undefined","ee","event","enableEvent","async","_router","Core"],"mappings":"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"}