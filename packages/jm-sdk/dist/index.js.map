{"version":3,"file":"index.js","sources":["../lib/sso.js","../lib/passport.js","../lib/login.js","../lib/index.js"],"sourcesContent":["const name = 'sso'\r\n\r\nmodule.exports = function (opts) {\r\n  let app = this\r\n  this.bind(name)\r\n  let $ = app[name]\r\n\r\n  $.verify = async function () {\r\n    let uri = '/verify'\r\n    let doc = await this.get(uri)\r\n    return doc\r\n  }\r\n\r\n  $.touch = async function (opts) {\r\n    let uri = '/touch'\r\n    let doc = await this.post(uri)\r\n    return doc\r\n  }\r\n\r\n  $.signout = async function () {\r\n    let uri = '/signout'\r\n    let doc = await this.get(uri)\r\n    return doc\r\n  }\r\n\r\n  return {\r\n    name,\r\n    unuse: () => {\r\n      delete app[name]\r\n    }\r\n  }\r\n}\r\n","const name = 'passport'\r\n\r\nmodule.exports = function (opts) {\r\n  let app = this\r\n  this.bind(name)\r\n  let $ = app[name]\r\n\r\n  $.login = async function (username, password) {\r\n    let uri = '/login'\r\n    let doc = await this.post(uri, {username, password})\r\n    return doc\r\n  }\r\n\r\n  return {\r\n    name,\r\n    unuse: () => {\r\n      delete app[name]\r\n    }\r\n  }\r\n}\r\n","const name = 'login'\r\n\r\nmodule.exports = function (opts) {\r\n  let app = this\r\n  let doLogin = null\r\n\r\n  async function checkOrLogin () {\r\n    let store = app.store\r\n    let storage = app.storage\r\n    let doc = storage.getJson('sso')\r\n    if (doc) {\r\n      store.sso = doc\r\n      try {\r\n        doc = await app.sso.verify()\r\n      } catch (e) {\r\n        doc = e.data || {}\r\n      }\r\n      if (!doc || !doc.token) {\r\n        doc = null\r\n        storage.removeItem('sso')\r\n        delete store.sso\r\n      }\r\n    }\r\n    if (!doc) {\r\n      if (!app.login) throw new Error('login 接口未实现')\r\n      doc = await app.login()\r\n      if (doc && doc.token) {\r\n        storage.setJson('sso', doc)\r\n        store.sso = doc\r\n      }\r\n    }\r\n    return doc\r\n  }\r\n\r\n  app.checkLogin = async function () {\r\n    if (doLogin) return doLogin\r\n    doLogin = new Promise(\r\n      async (resolve, reject) => {\r\n        try {\r\n          let doc = await checkOrLogin()\r\n          resolve(doc)\r\n        } catch (e) {\r\n          reject(e)\r\n        }\r\n        doLogin = false\r\n      }\r\n    )\r\n    return doLogin\r\n  }\r\n\r\n  /**\r\n   * 判断是否已经登陆\r\n   */\r\n  app.isLoggedIn = function () {\r\n    return this.store.sso\r\n  }\r\n\r\n  /**\r\n   * 登出\r\n   */\r\n  app.logout = function () {\r\n    delete this.store.sso\r\n    this.storage.removeItem('sso')\r\n  }\r\n\r\n  return {\r\n    name,\r\n    unuse: () => {\r\n      delete app.checkLgoin\r\n      delete app.isLoggedIn\r\n      delete app.logout\r\n    }\r\n  }\r\n}\r\n","const event = require('jm-event')\nconst utils = require('jm-ms-core').utils\nconst Core = require('jm-sdk-core')\nconst sso = require('./sso')\nconst passport = require('./passport')\nconst login = require('./login')\n\nconst types = ['get', 'post', 'put', 'delete', 'patch']\n\nclass Sdk extends Core {\n  constructor (opts = {}) {\n    super(opts)\n    this.ready = false\n    this.store.config = opts\n\n    types.forEach(type => {\n      this.bindType(this, type)\n    })\n\n    const mdls = {\n      sso,\n      passport,\n      login\n    }\n    let modules = Object.assign({}, opts.modules)\n    Object.keys(mdls).forEach(\n      key => {\n        if (!modules[key]) return\n        let cfg = Object.assign({}, opts, modules[key])\n        this.use(mdls[key], cfg)\n      }\n    )\n\n    this.onReady()\n  }\n\n  get router () { return this._router }\n\n  set router (value) {\n    if (!value) throw new Error('invalie router')\n    this._router = value\n    this.ready = true\n    this.emit('ready')\n  }\n\n  async onReady () {\n    if (this.ready) return this.ready\n    if (this.initing) return this.initing\n\n    this.initing = new Promise(\n      async (resolve, reject) => {\n        this.once('ready', doc => {\n          this.ready = true\n          resolve(this.ready)\n        })\n        delete this.initing\n      }\n    )\n    return this.initing\n  }\n\n  async request (...args) {\n    this.ready || await this.onReady()\n    if (!this.router) throw new Error('invalid router')\n    let opts = utils.preRequest(...args)\n    let sso = this.store.sso || {}\n    if (sso.token) {\n      opts.headers || (opts.headers = {})\n      opts.headers.Authorization = sso.token\n    }\n    try {\n      let doc = await this.router.request(opts)\n      let s = `request:\\n${JSON.stringify(opts, null, 2)}\\nresult:\\n${JSON.stringify(doc, null, 2)}`\n      this.logger.debug(s)\n      return doc\n    } catch (e) {\n      if (e.data && e.data.err === 401 && this.checkLogin) {\n        this.logger.debug('not login, so checkLogin and try again')\n        sso = await this.checkLogin()\n        if (sso.token) {\n          opts.headers || (opts.headers = {})\n          opts.headers.Authorization = sso.token\n          try {\n            let doc = await this.router.request(opts)\n            let s = `request:\\n${JSON.stringify(opts, null, 2)}\\nresult:\\n${JSON.stringify(doc, null, 2)}`\n            this.logger.debug(s)\n            return doc\n          } catch (e) {\n            const ret = await this.emit('error', e, opts)\n            if (ret !== undefined) return ret\n            throw e\n          }\n        }\n      }\n      const ret = await this.emit('error', e, opts)\n      if (ret !== undefined) return ret\n      throw e\n    }\n  }\n\n  bindType ($, type, uri = '') {\n    $[type] = async (...args) => {\n      let opts = utils.preRequest(...args)\n      opts.uri = `${uri}${opts.uri}`\n      opts.type = type\n      let doc = await this.request(opts)\n      return doc\n    }\n  }\n\n  bind (name, uri) {\n    uri || (uri = '/' + name)\n    let $ = {}\n    event.enableEvent($, {async: true})\n    types.forEach(type => {\n      this.bindType($, type, uri)\n    })\n    this[name] = $\n    return this\n  }\n}\n\nmodule.exports = Sdk\n"],"names":["name","opts","app","bind","$","verify","uri","get","touch","post","signout","unuse","login","username","password","checkOrLogin","store","storage","doc","getJson","sso","e","data","token","removeItem","Error","setJson","doLogin","checkLogin","Promise","resolve","reject","isLoggedIn","logout","checkLgoin","utils","require$$0","require$$1","types","Sdk","ready","config","forEach","type","bindType","mdls","passport","modules","Object","assign","keys","key","cfg","use","onReady","initing","once","args","router","preRequest","headers","Authorization","request","s","JSON","stringify","logger","debug","err","emit","ret","undefined","event","enableEvent","async","_router","value","Core"],"mappings":"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"}